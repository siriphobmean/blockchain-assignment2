<!DOCTYPE html>
<html lang="en">

<head>
    <title>Movie Shop</title>
    <link rel="stylesheet" type="text/css" href="main.css">
    <!-- <script src="./node_modules/web3/dist/web3.min.js">
    </script> -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.3/dist/web3.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>กรุณาเลือกหนังที่ต้องการซื้อ</h1>
        <!-- โดเรม่อน -->
        <label class="col-lg-2 control-label">โดเรม่อน 0.001 Ether</label>
        <button id="btnRegistration" onclick="buyMovie('โดเรม่อน', 0.001)">Buy</button>

        <!-- วันพีช -->
        <label class="col-lg-2 control-label">วันพีช 0.002 Ether</label>
        <button id="btnRegistration" onclick="buyMovie('วันพีช', 0.002)">Buy</button>

        <!-- นารูโตะ -->
        <label class="col-lg-2 control-label">นารูโตะ 0.003 Ether</label>
        <button id="btnRegistration" onclick="buyMovie('นารูโตะ', 0.003)">Buy</button>

        <!-- ชินจัง -->
        <label class="col-lg-2 control-label">ชินจัง 0.004 Ether</label>
        <button id="btnRegistration" onclick="buyMovie('ชินจัง', 0.004)">Buy</button>

        <!-- กาฟิวส์ -->
        <label class="col-lg-2 control-label">กาฟิวส์ 0.005 Ether</label>
        <button id="btnRegistration" onclick="buyMovie('กาฟิวส์', 0.005)">Buy</button>

        <label class="col-lg-2 control-label">Status</label>
        <h2 id="result"></h2>
        Status: <span id="status">Loading...</span>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js">
    </script>
    <script>

        // ===Connecting to MetaMask===
        function loadWeb3() {
            if (window.ethereum) {
                // To get web3(.js) object
                web3 = new Web3(window.ethereum);

                // To request user's account from Metamask
                ethereum
                    .request({ method: 'eth_requestAccounts' })
                    .then(handleAccountsChanged)
                    .catch((err) => {
                        if (err.code === 4001) {
                            // If this happens, the user rejected the connection request.
                            console.log('Please connect to MetaMask.');
                        } else {
                            console.error(err);
                        }
                    });
            }
        }

        // ===Handle user accounts and accountsChanged===
        let currentAccount = null;

        // Note that this event is emitted on page load.
        // If the array of accounts is non-empty, you're already connected.
        window.ethereum.on('accountsChanged', handleAccountsChanged);

        // For now, 'eth_accounts' will continue to always return an array
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                // MetaMask is locked or the user has not connected any accounts
                console.log('Please connect to MetaMask.');
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
            }
        }

        let abi = [
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "text",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "bytes32",
                        "name": "hash",
                        "type": "bytes32"
                    }
                ],
                "name": "NameAdded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "text",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "reason",
                        "type": "string"
                    }
                ],
                "name": "RegistrationError",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    }
                ],
                "name": "checkName",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    }
                ],
                "name": "registration",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            }
        ]; // version 3

        async function loadContract() {
            return await new web3.eth.Contract(abi, '0x947Aec3Ce48BF00CAd51AF9787fFBf252a035Ce4'); // version 3
        }

        async function load() {
            await loadWeb3();
            web3.contract = await loadContract();
            updateStatus('Ready!');
        }

        function updateStatus(status) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = status;
            console.log(status);
        }

        function buyMovie(movie, price) {
            console.log(currentAccount);
            web3.contract.methods.registration(movie)
                .send({
                    from: currentAccount,
                    value: web3.utils.toWei(price.toString(), "ether")
                }, function (error, result) {
                    if (error) {
                        $("#result").html("Error: " + error.message);
                    }
                });
        
            web3.contract.once('NameAdded', {}, function (error, event) {
                if (!error) {
                    console.log(event);
                    $("#result").html("You have successfully purchased: " + event.returnValues.text);
                }
            });
        }        

        load();
    </script>
</body>

</html>